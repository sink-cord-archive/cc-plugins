(function(l,h,b,o,u,s,m){"use strict";function _(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var n=_(l),w=_(b);const N=/[^\S\r\n]*?\r?\n[^\S\r\n]*?\*[^\S\r\n]?/,S=/^\\@/;function x(e){try{return JSON.parse(e)}catch{}}function T(e){const t=e.split(`
`)[0];if(t.includes("//META"))return M(e);if(t.includes("/**"))return D(e);throw new Error("META was not found.")}function M(e){const t=e.split(`
`)[0],a=t.substring(t.lastIndexOf("//META")+6,t.lastIndexOf("*//")),r=x(a);if(!r)throw new Error("META could not be parsed.");if(!r.name)throw new Error("META missing name data.");return r}function D(e){const t=e.split("/**",2)[1].split("*/",1)[0],a={};let r="",i="";for(const c of t.split(N))if(c.length!==0)if(c.charAt(0)==="@"&&c.charAt(1)!==" "){a[r]=i;const d=c.indexOf(" ");r=c.substr(1,d-1),i=c.substr(d+1)}else i+=" "+c.replace("\\n",`
`).replace(S,"@");return a[r]=i.trim(),delete a[""],a}var C=async(e,t)=>{const a=await(await fetch(new URL(e,t).href)).text();return{id:`${t}___${e}`,CSS:a,...T(a)}};async function B(e){const t=new URL("repo.json",e).href,a=await(await fetch(t)).json();if(!a.themes||a.themes?.length===0)throw new Error("No themes found in repo");if(!a.meta)throw new Error("No repo metadata");if(!a?.meta.name)throw new Error("Repo did not have a name");return a}var f=async e=>{const t=await B(e),a=await Promise.all(t.themes.map(r=>C(r,e)));return{manifest:t,themes:a}};function y(e){if(!e?.id||!e.CSS)throw new Error("theme was missing either id or css.");const t=h.injectCSS(e.CSS);n.default.state.ghost.unpatchCache.set(e.id,t),n.default.persist.store.themes=n.default.persist.ghost.themes.filter(a=>a.id!==e.id),n.default.persist.store.themes.push({id:e.id,enabled:!0})}function g(e){if(!e?.id)throw new Error("theme was missing id.");const t=n.default.state.ghost.unpatchCache.get(e.id);if(!t)throw new Error("theme was not loaded.");t(),n.default.state.ghost.unpatchCache.delete(e.id),n.default.persist.store.themes=n.default.persist.ghost.themes.filter(a=>a.id!==e.id),n.default.persist.store.themes.push({id:e.id,enabled:!1})}function F(e){try{g(e)}catch(t){if(t.message!=="theme was not loaded.")throw t}n.default.persist.store.themes=n.default.persist.ghost.themes.filter(t=>t.id!==e.id)}function k(){n.default.state.ghost.unpatchCache.forEach(e=>e?.()),n.default.state.ghost.unpatchCache.clear()}var $=async()=>{if(!l.persist.ghost.repos||!l.persist.ghost.themes)return k;const e=l.persist.ghost.repos,a=(await Promise.all(e.map(async i=>[i,await f(i)]))).flatMap(([i,c])=>c.themes.map(d=>({...d,repoUrl:i}))),r=l.persist.ghost.themes.filter(i=>i.enabled);return a.filter(i=>r.some(c=>i.id===c.id)).forEach(y),k},L=()=>(n.default.persist.ghost.repos||(n.default.persist.store.repos=[]),n.default.persist.ghost.themes||(n.default.persist.store.themes=[]),n.default.state=w.default.make({unpatchCache:new Map}),()=>{n.default.state=void 0,delete n.default.state});const A=s.React.useState,I=s.React.createElement,z=o.findByDisplayName("FormText"),O=o.findByDisplayName("FormDivider");var U=({items:e})=>{let[t,a]=A(0);return s.React.createElement("div",{className:"ysink_stain_tabbar_root"},s.React.createElement("div",{className:"ysink_stain_tabbar"},e.map((r,i)=>s.React.createElement("button",{className:"ysink_stain_button"+(i===t?" ysink_stain_selected":""),onClick:()=>a(i)},s.React.createElement(z,null,r.text)))),s.React.createElement(O,{className:"ysink_stain_divide"}),s.React.createElement("div",{className:"ysink_stain_tabbar_content"},I(e[t].component)))},j=({theme:e,onClick:t})=>s.React.createElement("svg",{onClick:t,className:"ysink_stain_delete",xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px"},s.React.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),s.React.createElement("path",{d:"M0 0h24v24H0V0z",fill:"none"}),s.React.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"}));const H=o.findByDisplayName("FormTitle"),p=o.findByDisplayName("FormText"),P=o.findByDisplayName("FormSection"),V=o.findByDisplayName("FormDivider"),J=o.findByDisplayName("Switch"),E=e=>{for(const t of l.persist.ghost.themes)if(t.id===e&&t.enabled)return!0;return!1},G=e=>l.persist.ghost.themes.some(t=>t.id===e);var v=({theme:e,deleteHook:t})=>(m.useNest(l.persist),s.React.createElement("div",{className:"ysink_stain_card"},s.React.createElement(P,null,s.React.createElement("div",{className:"ysink_stain_img",style:{backgroundImage:`url(${e.media})`}},e.media?[]:s.React.createElement(p,null,"No Image")),s.React.createElement("div",{className:"ysink_stain_row"},s.React.createElement(H,{tag:"p",className:"ysink_stain_title"},e.name),G(e.id)?s.React.createElement(j,{theme:e,onClick:()=>{F(e),t?.()}}):[],s.React.createElement(J,{checked:E(e.id),onChange:()=>E(e.id)?g(e):y(e)})),s.React.createElement(p,{className:"ysink_stain_desc"},e.description),s.React.createElement(V,{className:"ysink_stain_divide"}),s.React.createElement(p,{className:"ysink_stain_author_licence"},e.author?`by ${e.author} `:"",e.license?`under ${e.license}`:""))));const{useState:q,useEffect:K}=s.React,Q=()=>Promise.all(l.persist.ghost.repos.map(f)),W=async()=>(await Q()).flatMap(e=>e.themes).filter(e=>l.persist.ghost.themes.some(t=>e.id===t.id));var X=()=>{m.useNest(l.persist);let[e,t]=q(void 0);return K(()=>{e||W().then(t)}),s.React.createElement(u.ErrorBoundary,null,s.React.createElement("div",{className:"ysink_stain_cardcontainer"},(e??[]).map(a=>s.React.createElement(v,{theme:a,deleteHook:()=>t(void 0)}))))};const{useState:R,useEffect:Y,useReducer:Z}=s.React,ee=()=>Promise.all(l.persist.ghost.repos.map(f)),te=e=>e.flatMap(t=>t.themes);async function se(){let e=await ee();return{repos:e,themes:te(e)}}var ae=()=>{m.useNest(l.persist,!1,(c,d)=>d?.[0]==="repos");let[e,t]=R(void 0),[a,r]=R(void 0);Y(()=>{(!e||!a)&&se().then(({repos:c,themes:d})=>{t(c),r(d)})});const[,i]=Z(c=>~c,0);return s.React.createElement(u.ErrorBoundary,null,s.React.createElement("div",{className:"ysink_stain_cardcontainer"},(a??[]).map(c=>s.React.createElement(v,{theme:c,deleteHook:i}))))};const ne=o.findByDisplayName("FormTitle"),re=o.findByDisplayName("FormSection");var ie=()=>s.React.createElement(u.ErrorBoundary,null,s.React.createElement(re,null,s.React.createElement(ne,{tag:"h1"},"Cumstain"),s.React.createElement(U,{items:[{text:"Store",component:ae},{text:"Installed",component:X}]}))),ce=()=>h.after("getPredicateSections",o.findByDisplayName("SettingsView").prototype,(e,t)=>{if(t[1]?.section!="My Account")return;let a=t.findIndex(r=>r.section=="CUMCORD_PLUGINS")+1;return t.splice(a,0,{section:"ysink_stain_CUMSTAIN",label:"Themes",element:ie}),t}),le=()=>cumcord.patcher.injectCSS(".ysink_stain_tabbar{padding:.5rem 1rem;display:grid;grid-auto-flow:column;grid-auto-columns:7rem}.ysink_stain_tabbar .ysink_stain_button *{cursor:pointer}.ysink_stain_tabbar>*{margin-right:1rem;padding:.2rem;border-radius:.3rem;min-width:5rem;text-align:center;background:none}.theme-dark .ysink_stain_tabbar>*.ysink_stain_selected{background:#fff4}.theme-light .ysink_stain_tabbar>*.ysink_stain_selected{background:#0003}.ysink_stain_tabbar>*:last-child{margin-right:0}.ysink_stain_cardcontainer{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}.ysink_stain_card{padding:1rem;border:1px solid var(--background-modifier-accent);border-radius:.5rem;display:flex;flex-direction:column;z-index:1;background-color:var(--deprecated-card-bg)}.ysink_stain_card .ysink_stain_title{font-size:1rem;padding-bottom:.25rem;display:inline;flex:1;margin:0}.ysink_stain_card .ysink_stain_button{display:inline;padding:0}.ysink_stain_card .ysink_stain_button>div{padding:2px 16px}.ysink_stain_card .ysink_stain_row{display:flex}.ysink_stain_card .ysink_stain_row>:first-child{flex:1}.ysink_stain_card .ysink_stain_row>*{flex:unset}.ysink_stain_card .ysink_stain_author_licence{font-style:italic}.ysink_stain_card .ysink_stain_desc{flex:1}.ysink_stain_card .ysink_stain_img{height:13rem;background-repeat:no-repeat;background-size:cover;background-position:center;margin:-1rem -1rem 1rem;border-radius:.5rem .5rem 0 0}.ysink_stain_card .ysink_stain_img div{font-size:1.5rem;text-align:center;padding-top:calc(6.5rem - .5em);text-transform:uppercase;opacity:.8}.ysink_stain_divide{margin:0 0 1rem}.ysink_stain_card .ysink_stain_divide{margin:.2rem 0}.ysink_stain_delete{margin-left:.5rem;fill:var(--interactive-normal)}"),oe=({persist:e})=>{let t=[];return{onLoad:async()=>{e.store.repos=["http://127.0.0.1:8080/"],t.push(le(),L(),await $(),ce())},onUnload:()=>t.reduceRight((a,r)=>r?.(),null)}};return oe})(cumcord.pluginData,cumcord.patcher,cumcord.modules.internal.nests,cumcord.modules.webpack,cumcord.ui.components,cumcord.modules.common,cumcord.utils);
